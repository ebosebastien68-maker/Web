<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; height: 100vh; overflow: hidden; }
        
        .messages-wrapper { height: 100vh; display: flex; flex-direction: column; }
        
        .messages-header { background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .messages-header h1 { color: #333; font-size: 20px; display: flex; align-items: center; gap: 10px; }
        .messages-header h1 i { color: #667eea; }
        
        .header-actions { display: flex; gap: 10px; }
        .action-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: transform 0.2s; font-size: 14px; }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        .action-btn.secondary { background: #f0f0f0; color: #667eea; }
        
        .messages-container { flex: 1; overflow: hidden; background: white; margin: 15px; border-radius: 15px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); display: flex; flex-direction: column; position: relative; }
        
        .chat-area { flex: 1; display: flex; flex-direction: column; min-height: 0; }
        
        .chat-header { padding: 15px 20px; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; gap: 12px; background: #fafbfc; flex-shrink: 0; }
        .chat-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; flex-shrink: 0; }
        .chat-user-info { flex: 1; }
        .chat-user-info h3 { color: #333; font-size: 15px; margin-bottom: 2px; }
        .chat-user-info p { color: #999; font-size: 12px; }
        
        .chat-messages { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden;
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            background: #f5f7fa;
            min-height: 0;
            scroll-behavior: smooth;
        }
        
        .message-bubble { max-width: 75%; padding: 12px 16px; border-radius: 18px; word-wrap: break-word; animation: slideIn 0.3s ease; opacity: 0; animation-fill-mode: forwards; }
        @keyframes slideIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .message-sent { align-self: flex-end; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-bottom-right-radius: 4px; }
        .message-received { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .message-text { margin-bottom: 5px; line-height: 1.4; font-size: 14px; white-space: pre-wrap; }
        .message-time { font-size: 10px; opacity: 0.7; }
        .message-image { max-width: 100%; max-height: 250px; border-radius: 12px; margin-top: 8px; cursor: pointer; transition: transform 0.2s; }
        .message-image:hover { transform: scale(1.02); }
        
        .message-sending { opacity: 0.6; }
        .message-sending::after { content: '‚è≥'; margin-left: 8px; }
        
        .chat-input-area { padding: 15px 20px; border-top: 1px solid #e0e0e0; display: flex; gap: 10px; align-items: center; background: white; flex-shrink: 0; }
        .attach-btn { background: #f0f0f0; border: none; color: #667eea; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; cursor: pointer; transition: all 0.3s; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .attach-btn:hover { background: #e0e0e0; transform: scale(1.05); }
        
        .input-wrapper { flex: 1; position: relative; display: flex; align-items: center; }
        .message-input { width: 100%; padding: 12px 45px 12px 18px; border: 2px solid #e0e0e0; border-radius: 25px; font-size: 14px; font-family: inherit; transition: border-color 0.3s; resize: none; max-height: 100px; }
        .message-input:focus { outline: none; border-color: #667eea; }
        
        .input-send-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 20px; color: #667eea; cursor: pointer; transition: color 0.3s, transform 0.2s; display: none; }
        .input-send-icon:hover { color: #764ba2; transform: translateY(-50%) scale(1.1); }
        
        .send-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 16px; flex-shrink: 0; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
        .send-btn:hover { transform: scale(1.1); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .send-btn:active { transform: scale(0.95); }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .send-btn:disabled:hover { transform: none; box-shadow: none; }
        
        .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; background: #f5f7fa; }
        .empty-state i { font-size: 60px; margin-bottom: 15px; color: #ddd; }
        .empty-state h3 { font-size: 16px; color: #666; margin-bottom: 8px; }
        .empty-state p { font-size: 13px; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 20px; width: 95%; max-width: 450px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; animation: modalSlide 0.3s ease; }
        @keyframes modalSlide { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .modal-header { padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .modal-header h3 { font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .close-modal { background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 20px; color: white; cursor: pointer; }
        .close-modal:hover { background: rgba(255,255,255,0.3); }
        
        .modal-search { padding: 15px; border-bottom: 1px solid #e0e0e0; }
        .modal-search input { width: 100%; padding: 10px 15px 10px 40px; border: 2px solid #e0e0e0; border-radius: 20px; font-size: 14px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23999" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>') no-repeat 12px center; }
        .modal-search input:focus { outline: none; border-color: #667eea; }
        
        .list-container { flex: 1; overflow-y: auto; }
        .list-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.2s; }
        .list-item:hover { background: #f8f9ff; }
        .list-item.active { background: #f0f0ff; border-left: 3px solid #667eea; }
        
        .item-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; flex-shrink: 0; }
        .item-info { flex: 1; min-width: 0; }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .item-name { font-weight: 600; color: #333; font-size: 14px; }
        .item-role { font-size: 10px; color: #667eea; background: #f0f0ff; padding: 2px 6px; border-radius: 8px; }
        .item-time { font-size: 11px; color: #999; }
        .item-preview { font-size: 12px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-unread { background: #667eea; color: white; border-radius: 10px; padding: 2px 7px; font-size: 10px; font-weight: bold; flex-shrink: 0; }
        
        .loading { text-align: center; padding: 30px; color: #999; }
        .loading i { font-size: 30px; }
        
        .chat-messages::-webkit-scrollbar { width: 8px; }
        .chat-messages::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .chat-messages::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, #764ba2 0%, #667eea 100%); }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }

        .typing-indicator { padding: 12px 16px; border-radius: 18px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.08); align-self: flex-start; max-width: 75px; display: none; }
        .typing-indicator span { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #999; margin: 0 2px; animation: typing 1.4s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.7; } 30% { transform: translateY(-10px); opacity: 1; } }
    </style>
</head>
<body>
    <div class="messages-wrapper">
        <div class="messages-header">
            <h1><i class="fas fa-comments"></i> <span id="header-title">Messagerie</span></h1>
            <div class="header-actions">
                <button class="action-btn secondary" onclick="openConversationsModal()">
                    <i class="fas fa-list"></i>
                    <span>Conversations</span>
                </button>
                <button class="action-btn" onclick="openContactsModal()">
                    <i class="fas fa-user-plus"></i>
                    <span id="contacts-btn-text">Contacts</span>
                </button>
            </div>
        </div>

        <div class="messages-container">
            <div class="chat-area" id="chat-area">
                <div class="empty-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <h3>Chargement...</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="conversations-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-comments"></i> Conversations r√©centes</h3>
                <button class="close-modal" onclick="closeConversationsModal()">√ó</button>
            </div>
            <div class="modal-search">
                <input type="text" placeholder="Rechercher..." id="search-conversations">
            </div>
            <div class="list-container" id="conversations-list"></div>
        </div>
    </div>

    <div class="modal" id="contacts-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-address-book"></i> <span id="contacts-modal-title">Contacts</span></h3>
                <button class="close-modal" onclick="closeContactsModal()">√ó</button>
            </div>
            <div class="modal-search">
                <input type="text" placeholder="Rechercher..." id="search-contacts">
            </div>
            <div class="list-container" id="contacts-list"></div>
        </div>
    </div>

    <script src="supabaseClient.js"></script>
    <script>
        const { supabase, getCurrentUser, getUserProfile } = window.supabaseClient;
        let currentUser = null;
        let userProfile = null;
        let currentChatUser = null;
        let messageSubscription = null;
        let conversationsCache = [];
        let contactsCache = [];
        let messagesCache = new Map();
        let pendingMessages = new Set();

        window.addEventListener('DOMContentLoaded', async () => {
            currentUser = await getCurrentUser();
            if (!currentUser) {
                window.location.href = 'connexion.html';
                return;
            }

            userProfile = await getUserProfile(currentUser.id);
            await initInterface();

            document.getElementById('search-conversations').addEventListener('input', (e) => filterList('conversations', e.target.value));
            document.getElementById('search-contacts').addEventListener('input', (e) => filterList('contacts', e.target.value));
        });

        async function initInterface() {
            if (userProfile.role === 'user') {
                document.getElementById('contacts-btn-text').textContent = 'Admins';
                document.getElementById('contacts-modal-title').textContent = 'Administrateurs';
                await initUserChat();
            } else {
                document.getElementById('contacts-btn-text').textContent = 'Contacts';
                document.getElementById('contacts-modal-title').textContent = 'Tous les contacts';
                await initAdminChat();
            }
        }

        async function initUserChat() {
            const storedAdminId = localStorage.getItem(`default_admin_${currentUser.id}`);
            let defaultAdmin = null;

            if (storedAdminId) {
                const { data } = await supabase
                    .from('users_profile')
                    .select('*')
                    .eq('user_id', storedAdminId)
                    .eq('role', 'admin')
                    .single();
                defaultAdmin = data;
            }

            if (!defaultAdmin) {
                const { data: admins } = await supabase
                    .from('users_profile')
                    .select('user_id, prenom, nom, role')
                    .eq('role', 'admin')
                    .limit(10);

                if (admins && admins.length > 0) {
                    defaultAdmin = admins[Math.floor(Math.random() * admins.length)];
                    localStorage.setItem(`default_admin_${currentUser.id}`, defaultAdmin.user_id);
                }
            }

            if (defaultAdmin) {
                openChat(defaultAdmin);
            } else {
                showEmptyState('Aucun administrateur disponible');
            }

            await loadConversations();
        }

        async function initAdminChat() {
            await loadConversations();
            
            if (conversationsCache.length > 0) {
                openChat(conversationsCache[0].user);
            } else {
                showEmptyState('Aucune conversation', 'Attendez qu\'un utilisateur vous contacte');
            }
        }

        async function loadConversations() {
            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('message_id, sender_id, receiver_id, texte, date_created, read_status')
                    .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
                    .order('date_created', { ascending: false })
                    .limit(100);

                if (error) throw error;

                const userIds = new Set();
                messages.forEach(msg => {
                    const otherId = msg.sender_id === currentUser.id ? msg.receiver_id : msg.sender_id;
                    userIds.add(otherId);
                });

                if (userIds.size === 0) {
                    conversationsCache = [];
                    return;
                }

                const { data: users, error: usersError } = await supabase
                    .from('users_profile')
                    .select('user_id, prenom, nom, role')
                    .in('user_id', Array.from(userIds));

                if (usersError) throw usersError;

                const usersMap = {};
                users.forEach(u => { usersMap[u.user_id] = u; });

                const conversations = {};
                messages.forEach(msg => {
                    const otherId = msg.sender_id === currentUser.id ? msg.receiver_id : msg.sender_id;
                    const otherUser = usersMap[otherId];

                    if (!otherUser) return;
                    if (userProfile.role === 'user' && otherUser.role !== 'admin') return;

                    if (!conversations[otherId]) {
                        conversations[otherId] = {
                            user: otherUser,
                            lastMessage: msg,
                            unread: 0
                        };
                    }
                    if (msg.receiver_id === currentUser.id && !msg.read_status) {
                        conversations[otherId].unread++;
                    }
                });

                conversationsCache = Object.values(conversations).sort((a, b) =>
                    new Date(b.lastMessage.date_created) - new Date(a.lastMessage.date_created)
                );

            } catch (error) {
                console.error('Erreur:', error);
                conversationsCache = [];
            }
        }

        function openConversationsModal() {
            displayConversations(conversationsCache);
            document.getElementById('conversations-modal').classList.add('show');
        }

        function closeConversationsModal() {
            document.getElementById('conversations-modal').classList.remove('show');
        }

        function displayConversations(conversations) {
            const container = document.getElementById('conversations-list');

            if (conversations.length === 0) {
                container.innerHTML = '<div class="loading"><p>Aucune conversation</p></div>';
                return;
            }

            container.innerHTML = '';
            conversations.forEach(conv => {
                const initials = `${conv.user.prenom[0]}${conv.user.nom[0]}`.toUpperCase();
                const lastMsg = conv.lastMessage.texte?.substring(0, 40) || 'üì∑ Image';
                const time = formatTime(conv.lastMessage.date_created);

                const div = document.createElement('div');
                div.className = 'list-item';
                if (currentChatUser && currentChatUser.user_id === conv.user.user_id) {
                    div.classList.add('active');
                }
                div.onclick = () => {
                    closeConversationsModal();
                    openChat(conv.user);
                };
                div.innerHTML = `
                    <div class="item-avatar">${initials}</div>
                    <div class="item-info">
                        <div class="item-header">
                            <span class="item-name">${conv.user.prenom} ${conv.user.nom}</span>
                            ${conv.user.role === 'admin' ? '<span class="item-role">Admin</span>' : ''}
                            <span class="item-time">${time}</span>
                        </div>
                        <div class="item-preview">${lastMsg}</div>
                    </div>
                    ${conv.unread > 0 ? `<div class="item-unread">${conv.unread}</div>` : ''}
                `;
                container.appendChild(div);
            });
        }

        async function loadContacts() {
            try {
                const role = userProfile.role === 'user' ? 'admin' : null;
                let query = supabase
                    .from('users_profile')
                    .select('user_id, prenom, nom, role')
                    .neq('user_id', currentUser.id)
                    .order('prenom')
                    .limit(50);

                if (role) {
                    query = query.eq('role', role);
                }

                const { data, error } = await query;
                if (error) throw error;
                contactsCache = data || [];
            } catch (error) {
                console.error('Erreur:', error);
                contactsCache = [];
            }
        }

        function openContactsModal() {
            if (contactsCache.length === 0) {
                document.getElementById('contacts-list').innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Chargement...</p></div>';
                document.getElementById('contacts-modal').classList.add('show');
                loadContacts().then(() => displayContacts(contactsCache));
            } else {
                displayContacts(contactsCache);
                document.getElementById('contacts-modal').classList.add('show');
            }
        }

        function closeContactsModal() {
            document.getElementById('contacts-modal').classList.remove('show');
        }

        function displayContacts(contacts) {
            const container = document.getElementById('contacts-list');

            if (contacts.length === 0) {
                container.innerHTML = '<div class="loading"><p>Aucun contact</p></div>';
                return;
            }

            container.innerHTML = '';
            contacts.forEach(user => {
                const initials = `${user.prenom[0]}${user.nom[0]}`.toUpperCase();
                const div = document.createElement('div');
                div.className = 'list-item';
                div.onclick = () => {
                    closeContactsModal();
                    openChat(user);
                };
                div.innerHTML = `
                    <div class="item-avatar">${initials}</div>
                    <div class="item-info">
                        <div class="item-header">
                            <span class="item-name">${user.prenom} ${user.nom}</span>
                            ${user.role === 'admin' ? '<span class="item-role">Admin</span>' : ''}
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function filterList(type, query) {
            const data = type === 'conversations' ? conversationsCache : contactsCache;
            const filtered = data.filter(item => {
                const user = item.user || item;
                return `${user.prenom} ${user.nom}`.toLowerCase().includes(query.toLowerCase());
            });

            if (type === 'conversations') {
                displayConversations(filtered);
            } else {
                displayContacts(filtered);
            }
        }

        function openChat(user) {
            currentChatUser = user;
            const cacheKey = `${currentUser.id}-${user.user_id}`;
            messagesCache.set(cacheKey, []);
            
            const initials = `${user.prenom[0]}${user.nom[0]}`.toUpperCase();
            const chatArea = document.getElementById('chat-area');

            chatArea.innerHTML = `
                <div class="chat-header">
                    <div class="chat-avatar">${initials}</div>
                    <div class="chat-user-info">
                        <h3>${user.prenom} ${user.nom}</h3>
                        <p>${user.role === 'admin' ? 'Administrateur' : 'Utilisateur'}</p>
                    </div>
                </div>
                <div class="chat-messages" id="chat-messages"></div>
                <div class="chat-input-area">
                    <input type="file" id="image-input" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                    <button class="attach-btn" onclick="document.getElementById('image-input').click()">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <div class="input-wrapper">
                        <input type="text" class="message-input" id="message-input" placeholder="Votre message..." onkeypress="handleKeyPress(event)" autocomplete="off">
                        <i class="fas fa-arrow-circle-right input-send-icon" id="input-send-icon" onclick="sendMessage()"></i>
                    </div>
                    <button class="send-btn" onclick="sendMessage()" id="send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            `;

            loadMessages(user.user_id);
            markMessagesAsRead(user.user_id);
            subscribeToMessages(user.user_id);
            
            const input = document.getElementById('message-input');
            input.focus();
            
            input.addEventListener('input', updateSendButtonState);
            updateSendButtonState();
        }

        function updateSendButtonState() {
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const inputSendIcon = document.getElementById('input-send-icon');
            
            if (input && sendBtn && inputSendIcon) {
                const hasText = input.value.trim().length > 0;
                
                sendBtn.disabled = !hasText;
                sendBtn.style.opacity = hasText ? '1' : '0.5';
                inputSendIcon.style.display = hasText ? 'block' : 'none';
            }
        }

        async function loadMessages(otherUserId) {
            try {
                const { data, error } = await supabase
                    .from('messages')
                    .select('message_id, sender_id, texte, image_url, date_created')
                    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${otherUserId}),and(sender_id.eq.${otherUserId},receiver_id.eq.${currentUser.id})`)
                    .order('date_created', { ascending: true })
                    .limit(100);

                if (error) throw error;
                
                const cacheKey = `${currentUser.id}-${otherUserId}`;
                messagesCache.set(cacheKey, data);
                displayMessages(data);
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        function displayMessages(messages, scrollToBottom = true) {
            const container = document.getElementById('chat-messages');
            if (!container) return;

            const wasAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 100;
            container.innerHTML = '';

            messages.forEach((msg, index) => {
                const isSent = msg.sender_id === currentUser.id;
                const div = document.createElement('div');
                div.className = `message-bubble ${isSent ? 'message-sent' : 'message-received'}`;
                div.dataset.messageId = msg.message_id || `temp-${msg.tempId}`;
                
                if (msg.tempId && pendingMessages.has(msg.tempId)) {
                    div.classList.add('message-sending');
                }

                let content = '';
                if (msg.texte) content += `<div class="message-text">${escapeHtml(msg.texte)}</div>`;
                if (msg.image_url) content += `<img src="${msg.image_url}" class="message-image" onclick="window.open('${msg.image_url}', '_blank')" alt="Image">`;
                content += `<div class="message-time">${formatTime(msg.date_created || new Date())}</div>`;

                div.innerHTML = content;
                div.style.animationDelay = `${index * 0.05}s`;
                container.appendChild(div);
            });

            if (scrollToBottom && wasAtBottom) {
                requestAnimationFrame(() => {
                    container.scrollTop = container.scrollHeight;
                });
            }
        }

        function addMessageToUI(message) {
            const container = document.getElementById('chat-messages');
            if (!container) return;

            const isSent = message.sender_id === currentUser.id;
            const div = document.createElement('div');
            div.className = `message-bubble ${isSent ? 'message-sent' : 'message-received'}`;
            div.dataset.messageId = message.message_id || `temp-${message.tempId}`;

            let content = '';
            if (message.texte) content += `<div class="message-text">${escapeHtml(message.texte)}</div>`;
            if (message.image_url) content += `<img src="${message.image_url}" class="message-image" onclick="window.open('${message.image_url}', '_blank')" alt="Image">`;
            content += `<div class="message-time">${formatTime(message.date_created || new Date())}</div>`;

            div.innerHTML = content;
            container.appendChild(div);

            requestAnimationFrame(() => {
                container.scrollTop = container.scrollHeight;
            });
        }

        async function sendMessage(imageFile = null) {
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const texte = input ? input.value.trim() : '';

            if (!texte && !imageFile) return;
            if (!currentChatUser) return;

            if (sendBtn) {
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            const tempId = `temp-${Date.now()}-${Math.random()}`;
            pendingMessages.add(tempId);

            const optimisticMessage = {
                tempId: tempId,
                sender_id: currentUser.id,
                receiver_id: currentChatUser.user_id,
                texte: texte || null,
                image_url: null,
                date_created: new Date().toISOString()
            };

            const cacheKey = `${currentUser.id}-${currentChatUser.user_id}`;
            const currentMessages = messagesCache.get(cacheKey) || [];
            currentMessages.push(optimisticMessage);
            messagesCache.set(cacheKey, currentMessages);

            addMessageToUI(optimisticMessage);

            if (input) {
                input.value = '';
                input.focus();
            }

            try {
                let imageUrl = null;
                if (imageFile) {
                    const fileName = `${Date.now()}_${imageFile.name}`;
                    const { error: uploadError } = await supabase.storage
                        .from('messages-images')
                        .upload(fileName, imageFile);

                    if (uploadError) throw uploadError;
                    const { data } = supabase.storage.from('messages-images').getPublicUrl(fileName);
                    imageUrl = data.publicUrl;
                }

                const { data: newMessage, error } = await supabase
                    .from('messages')
                    .insert({
                        sender_id: currentUser.id,
                        receiver_id: currentChatUser.user_id,
                        texte: texte || null,
                        image_url: imageUrl
                    })
                    .select()
                    .single();

                if (error) throw error;

                pendingMessages.delete(tempId);

                const messages = messagesCache.get(cacheKey) || [];
                const tempIndex = messages.findIndex(m => m.tempId === tempId);
                if (tempIndex !== -1) {
                    messages[tempIndex] = newMessage;
                    messagesCache.set(cacheKey, messages);
                }

                const messageElement = document.querySelector(`[data-message-id="temp-${tempId}"]`);
                if (messageElement) {
                    messageElement.dataset.messageId = newMessage.message_id;
                    messageElement.classList.remove('message-sending');
                }

            } catch (error) {
                console.error('Erreur:', error);
                
                pendingMessages.delete(tempId);
                const messages = messagesCache.get(cacheKey) || [];
                const tempIndex = messages.findIndex(m => m.tempId === tempId);
                if (tempIndex !== -1) {
                    messages.splice(tempIndex, 1);
                    messagesCache.set(cacheKey, messages);
                }

                const messageElement = document.querySelector(`[data-message-id="temp-${tempId}"]`);
                if (messageElement) {
                    messageElement.remove();
                }

                alert('Erreur lors de l\'envoi du message');
                
                if (input) {
                    input.value = texte;
                }
            } finally {
                if (sendBtn) {
                    sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    updateSendButtonState();
                }
            }
        }

        async function markMessagesAsRead(otherUserId) {
            try {
                await supabase
                    .from('messages')
                    .update({ read_status: true })
                    .eq('sender_id', otherUserId)
                    .eq('receiver_id', currentUser.id)
                    .eq('read_status', false);
                
                setTimeout(() => loadConversations(), 500);
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        function subscribeToMessages(otherUserId) {
            if (messageSubscription) {
                supabase.removeChannel(messageSubscription);
            }

            const cacheKey = `${currentUser.id}-${otherUserId}`;

            messageSubscription = supabase
                .channel(`chat-${currentUser.id}-${otherUserId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages',
                    filter: `sender_id=eq.${otherUserId},receiver_id=eq.${currentUser.id}`
                }, (payload) => {
                    const newMessage = payload.new;
                    
                    const messages = messagesCache.get(cacheKey) || [];
                    const exists = messages.some(m => m.message_id === newMessage.message_id);
                    
                    if (!exists) {
                        messages.push(newMessage);
                        messagesCache.set(cacheKey, messages);
                        addMessageToUI(newMessage);
                        markMessagesAsRead(otherUserId);
                    }
                })
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages',
                    filter: `sender_id=eq.${currentUser.id},receiver_id=eq.${otherUserId}`
                }, (payload) => {
                    const newMessage = payload.new;
                    
                    const messages = messagesCache.get(cacheKey) || [];
                    const tempIndex = messages.findIndex(m => 
                        m.tempId && 
                        m.texte === newMessage.texte && 
                        Math.abs(new Date(m.date_created) - new Date(newMessage.date_created)) < 5000
                    );
                    
                    if (tempIndex !== -1) {
                        messages[tempIndex] = newMessage;
                        messagesCache.set(cacheKey, messages);
                        
                        const tempElement = document.querySelector(`[data-message-id^="temp-"]`);
                        if (tempElement && tempElement.querySelector('.message-text')?.textContent === newMessage.texte) {
                            tempElement.dataset.messageId = newMessage.message_id;
                            tempElement.classList.remove('message-sending');
                        }
                    }
                })
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'messages'
                }, () => {
                    loadConversations();
                })
                .subscribe();
        }

        function showEmptyState(title, subtitle = '') {
            document.getElementById('chat-area').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <h3>${title}</h3>
                    ${subtitle ? `<p>${subtitle}</p>` : ''}
                </div>
            `;
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return '√Ä l\'instant';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}min`;
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            }
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        }

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5000000) {
                    alert('L\'image est trop volumineuse (max 5MB)');
                    event.target.value = '';
                    return;
                }
                sendMessage(file);
            }
            event.target.value = '';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                const input = document.getElementById('message-input');
                if (input && input.value.trim().length > 0) {
                    sendMessage();
                }
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.getElementById('conversations-modal').addEventListener('click', function(e) {
            if (e.target === this) closeConversationsModal();
        });

        document.getElementById('contacts-modal').addEventListener('click', function(e) {
            if (e.target === this) closeContactsModal();
        });

        window.addEventListener('beforeunload', () => {
            if (messageSubscription) supabase.removeChannel(messageSubscription);
        });
    </script>
</body>
            </html>
